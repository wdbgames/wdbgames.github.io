<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WDBG</title>
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
      }

      iframe {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
      }
    </style>
  </head>
  <body>
    <iframe id="viewer"></iframe>
    <script src="scripts/main.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search);
      const type = Number(params.get("t"));
      const iframe = document.getElementById("viewer");
      if (type === 1) {
        const id = Number(params.get("id"));
        fetch("scripts/json/embed.json").then(res => res.json()).then(data => {
          const entry = data.find(e => e.id === id);
          iframe.src = entry?.link || "about:blank";
        }).catch(err => {
          console.error("Failed to load embed JSON", err);
          iframe.src = "about:blank";
        });
      } else if (type === 2) {
        const coverURL = "https://cdn.jsdelivr.net/gh/gn-math/covers@main";
        const htmlURL = "https://cdn.jsdelivr.net/gh/gn-math/html@main";
        const zonesSources = ["https://cdn.jsdelivr.net/%67%68/%67%6e%2d%6d%61%74%68/%61%73%73%65%74%73@%6d%61%69%6e/%7a%6f%6e%65%73%2e%6a%73%6f%6e", "https://cdn.jsdelivr.net/gh/gn-math/assets@latest/zones.json", "https://cdn.jsdelivr.net/gh/gn-math/assets@master/zones.json", "https://cdn.jsdelivr.net/gh/gn-math/assets/zones.json"];
        let zones = [];
        async function listZones() {
          try {
            let sha = null;
            const source = zonesSources[Math.floor(Math.random() * zonesSources.length)];
            try {
              const res = await fetch(source + "?t=" + Date.now());
              if (res.ok) {
                const json = await res.json();
                sha = Array.isArray(json) ? json[0]?.sha : null;
              }
            } catch {
              console.warn("Primary fetch failed");
            }
            if (!sha) {
              try {
                const fallback = await fetch("https://raw.githubusercontent.com/gn-math/xml/refs/heads/main/sha.txt?t=" + Date.now());
                if (fallback.ok) sha = (await fallback.text()).trim();
              } catch {
                console.error("SHA fallback failed");
              }
            }
            const zonesURL = sha ? `https://cdn.jsdelivr.net/gh/gn-math/assets@${sha}/zones.json?t=` + Date.now() : "https://cdn.jsdelivr.net/gh/gn-math/assets/zones.json";
            const res = await fetch(zonesURL);
            zones = await res.json();
            const id = params.get('id');
            const zone = zones.find(z => String(z.id) === String(id));
            if (zone) loadZoneContent(zone);
          } catch (e) {
            console.error("Failed to list zones", e);
          }
        }

        function loadZoneContent(zone) {
          if (zone.url.startsWith("http")) {
            window.location.href = zone.url;
          } else {
            const finalUrl = zone.url.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
            fetch(finalUrl + "?t=" + Date.now()).then(res => res.text()).then(html => {
              iframe.srcdoc = html;
            }).catch(err => console.error("Failed to load zone content", err));
          }
        }
        listZones();
      }
    </script>
  </body>
</html>